version: '3.9'

services:
  config-server:
    build: ./config-server
    ports:
      - "8888:8888"
    environment:
      - SPRING_PROFILES_ACTIVE=native
      - CONFIG_REPO=/config-repo
    volumes:
      - ./config-repo:/config-repo
    networks:
      - backend

  discovery-server:
    build: ./discovery-server
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - PORT=8761
    depends_on:
      - config-server
    networks:
      - backend

  api-gateway:
    build: ./api-gateway
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - PORT=8080
    depends_on:
      - config-server
      - discovery-server
      - keycloak
    networks:
      - backend

  nonconformity-service:
    build: ./nonconformity-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - PORT=8081
      - DB_URL=jdbc:mysql://mysql:3306/nonconformity_db
      - DB_USER=root
      - DB_PASSWORD=changeme
    depends_on:
      - mysql
      - config-server
      - discovery-server
    networks:
      - backend

  action-service:
    build: ./action-service
    ports:
      - "3001:3001"
    environment:
      - MONGO_URL=mongodb://mongo:27017/action_db
      - PORT=3001
    depends_on:
      - mongo
    networks:
      - backend

  frontend:
    build: ./frontend
    ports:
      - "4200:4200"
    environment:
      - API_BASE=http://localhost:8080
    depends_on:
      - api-gateway
    networks:
      - backend

  mysql:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: changeme
      MYSQL_DATABASE: nonconformity_db
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - backend

  mongo:
    image: mongo:6.0
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: action_db
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - backend

  keycloak:
    image: quay.io/keycloak/keycloak:24.0.4
    command: start-dev --http-port=8085 --import-realm
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
    ports:
      - "8085:8085"
    volumes:
      - ./docker/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json
    networks:
      - backend

volumes:
  mysql_data:
  mongo_data:

networks:
  backend:

